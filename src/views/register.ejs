<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Crear cuenta – MercaGo</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body class="auth-body">
  <div class="auth-page">
    <div class="auth-card">
      <h1 class="auth-title">Crear cuenta en MercaGo</h1>
      <p class="auth-subtitle">Únete a la red social de abarrotes.</p>

      <form id="formRegistro" class="auth-form">
        <div class="auth-field">
          <label>Nombre Completo</label>
          <input type="text" name="username" class="auth-input" required>
        </div>

        <div class="auth-field">
          <label>Correo</label>
          <input type="email" name="email" class="auth-input" required>
        </div>

        <div class="auth-field">
          <label>Contraseña</label>
          <input type="password" name="password" class="auth-input" required>
        </div>

        <div class="auth-field">
          <label>Tipo de cuenta</label>
          <select name="tipoCuenta" id="tipoCuenta" class="auth-input" required>
            <option value="USUARIO">Usuario</option>
            <option value="NEGOCIO">Negocio de abarrotes</option>
          </select>
        </div>

        <div class="auth-field">
          <label>Nombre de usuario (visible en el perfil)</label>
          <input type="text" name="name" class="auth-input">
        </div>

        <div class="auth-field">
          <label>Bio</label>
          <textarea name="bio" class="auth-input"></textarea>
        </div>

        <!-- Campos de tienda (solo para NEGOCIO) -->
        <div id="storeFields" style="display:none; margin-top:0.5rem;">
          <h3 class="auth-subtitle" style="margin-bottom:0.6rem;">Datos de la tienda</h3>

          <div class="auth-field">
            <label>Nombre de la tienda</label>
            <input type="text" name="storeName" class="auth-input">
          </div>

          <div class="auth-field">
            <label>Ciudad</label>
            <input type="text" name="storeCity" class="auth-input">
          </div>

          <div class="auth-field">
            <label>Distrito</label>
            <input type="text" name="storeDistrict" class="auth-input">
          </div>

          <div class="auth-field">
            <label>Dirección</label>
            <input type="text" name="storeAddress" class="auth-input">
          </div>

          <div class="auth-field">
            <label>Teléfono</label>
            <input type="text" name="storePhone" class="auth-input">
          </div>
        </div>

        <p id="registerError" class="auth-error" style="display:none;"></p>

        <button type="submit" class="auth-button">Registrarme</button>
      </form>

      <p class="auth-footer-text">
        ¿Ya tienes cuenta?
        <a href="/login" class="auth-link">Inicia sesión</a>
      </p>
    </div>
  </div>

  <script>
    // Mostrar/ocultar campos de tienda
    const tipoSelect = document.getElementById("tipoCuenta");
    const storeFields = document.getElementById("storeFields");
    const errorBox = document.getElementById("registerError");
    const form = document.getElementById("formRegistro");

    tipoSelect.addEventListener("change", () => {
      if (tipoSelect.value === "NEGOCIO") {
        storeFields.style.display = "block";
      } else {
        storeFields.style.display = "none";
      }
    });

    // Enviar datos a la API
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      errorBox.style.display = "none";
      errorBox.textContent = "";

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      try {
        const resp = await fetch("/api/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        const json = await resp.json();

        if (!resp.ok) {
          errorBox.textContent = json.message || "No se pudo completar el registro.";
          errorBox.style.display = "block";
          return;
        }

        alert("Registro exitoso");
        window.location.href = "/login";
      } catch (err) {
        console.error(err);
        errorBox.textContent = "Error de conexión con el servidor.";
        errorBox.style.display = "block";
      }
    });
  </script>
</body>
</html>
