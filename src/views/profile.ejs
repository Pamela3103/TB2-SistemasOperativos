<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Perfil ‚Äì MercaGo</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body class="mg-body">

  <!-- NAVBAR SUPERIOR -->
  <header class="mg-navbar">
    <div class="mg-navbar-left">
      <span class="mg-logo">MercaGo</span>
    </div>
    <div class="mg-navbar-center">
      <input type="text" class="mg-search" placeholder="Buscar tiendas o usuarios...">
      <div id="searchResults" class="mg-search-results hidden"></div>
    </div>
    <div class="mg-navbar-right">
      <button class="mg-icon-btn" onclick="window.location.href='/feed'">üè†</button>
      <button class="mg-icon-btn" id="btnNotif">üîî</button>
      <button class="mg-icon-btn mg-icon-btn--active">üë§</button>
    </div>
  </header>

  <!-- PANEL DE NOTIFICACIONES -->
  <div id="notifPanel" class="mg-notif-panel" style="display:none;">
    <div class="mg-notif-header">
      <h4>Notificaciones</h4>
    </div>
    <div id="notifList" class="mg-notif-list">
      <!-- Se llena por JS -->
    </div>
  </div>

  <!-- CONTENIDO PERFIL -->
  <main class="mg-main mg-main-profile">
    <div class="mg-profile-layout">

      <!-- COLUMNA IZQUIERDA: info de usuario -->
      <section class="mg-profile-card">
        <div class="mg-profile-header">
          <div class="mg-profile-avatar">
            <img id="pAvatar" src="" alt="">
          </div>

          <div>
            <h1 class="mg-profile-name" id="pName">Nombre de usuario</h1>
            <p class="mg-profile-username" id="pUsername">@username</p>
            <span class="mg-profile-tag" id="pTipo">Tipo de cuenta</span>
            <p class="mg-profile-bio" id="pBio">Bio...</p>
          </div>
        </div>

        <div class="mg-profile-stats">
          <div>
            <span id="pPosts" class="mg-profile-stat-number">0</span>
            <span class="mg-profile-stat-label">Publicaciones</span>
          </div>
          <div>
            <span id="pFollowers" class="mg-profile-stat-number">0</span>
            <span class="mg-profile-stat-label">Seguidores</span>
          </div>
          <div>
            <span id="pFollowing" class="mg-profile-stat-number">0</span>
            <span class="mg-profile-stat-label">Siguiendo</span>
          </div>
        </div>

        <!-- BOT√ìN PRINCIPAL DIN√ÅMICO: EDITAR PERFIL / SEGUIR -->
        <button id="profile-main-btn" class="mg-profile-btn-primary">
          <!-- El texto se define por JS -->
        </button>
      </section>

      <!-- COLUMNA DERECHA: tienda y posts -->
      <section class="mg-profile-right">

        <!-- TARJETA DE TIENDA (solo si tiene NEGOCIO) -->
        <div id="pf-store-card" class="mg-store-card" style="display:none;">
          <div class="mg-store-header">
            <h3 id="pf-store-name">Nombre de la tienda</h3>
            <span class="mg-store-pill">Tienda asociada</span>
          </div>
          <p id="pf-store-address" class="mg-store-text"></p>
          <p id="pf-store-city" class="mg-store-text"></p>
          <p id="pf-store-phone" class="mg-store-text"></p>

          <button id="pf-store-btn" class="mg-profile-btn-outline">
            Ver cat√°logo
          </button>
        </div>

        <!-- PUBLICACIONES DEL PERFIL -->
        <div class="mg-profile-posts">
          <h3 class="mg-section-title">Publicaciones de este perfil</h3>
          <div id="pf-posts-list"></div>
        </div>

      </section>
    </div>
  </main>

  <script>
    // 1) Verificar login
    const loggedUserId = sessionStorage.getItem("userId");
    if (!loggedUserId) {
      window.location.href = "/login";
    }

    // 2) Determinar de qu√© perfil estamos hablando (propio u otro)
    //    Asumimos rutas tipo:
    //    - /profile           -> perfil propio
    //    - /profile/:id       -> perfil de otro usuario
    let profileUserId;
    async function actualizarEstadoFollow(mainBtn, userId) {
      try {
        if (userId === loggedUserId) return;

        const resp = await fetch(`/api/follow/status/${userId}?myId=${loggedUserId}`);
        if (!resp.ok) return;

        const data = await resp.json();
        mainBtn.textContent = data.isFollowing ? "Siguiendo" : "Seguir";
      } catch (err) {
        console.error(err);
      }
    }


    const pathParts = window.location.pathname.split("/").filter(Boolean); // quita vac√≠os

    if (pathParts[0] === "profile" && pathParts[1]) {
      // /profile/:id
      profileUserId = pathParts[1];
    } else {
      // /profile (sin id expl√≠cito) -> perfil propio
      profileUserId = loggedUserId;
    }

    // 3) Cargar perfil completo desde la API
    async function cargarPerfil() {
      try {
        // ahora pedimos el perfil del due√±o de la p√°gina (profileUserId)
        const resp = await fetch(`/api/profile/${profileUserId}`);
        if (!resp.ok) throw new Error("No se pudo cargar el perfil");

        const { user, store, posts } = await resp.json();

        // ----- Usuario -----
        document.getElementById("pName").textContent = user.name || user.username;
        document.getElementById("pUsername").textContent = "@" + user.username;
        document.getElementById("pTipo").textContent =
          user.tipoCuenta === "NEGOCIO" ? "Cuenta de tienda" : "Cuenta personal";
        document.getElementById("pBio").textContent =
          user.bio || "Este usuario a√∫n no ha escrito una bio.";

        document.getElementById("pPosts").textContent =
          user.postCount || (posts ? posts.length : 0) || 0;
        document.getElementById("pFollowers").textContent =
          user.followersCount || 0;
        document.getElementById("pFollowing").textContent =
          user.followingCount || 0;

        const avatar = document.getElementById("pAvatar");
        if (user.profilePhoto) {
          avatar.src = user.profilePhoto;
        } else {
          avatar.src = "https://via.placeholder.com/80?text=" +
            (user.username || "U")[0].toUpperCase();
        }

        // ----- BOT√ìN PRINCIPAL: EDITAR PERFIL vs SEGUIR -----
                // ----- BOT√ìN PRINCIPAL: EDITAR PERFIL vs SEGUIR -----
        const mainBtn = document.getElementById("profile-main-btn");

        if (profileUserId === loggedUserId) {
          // Es mi propio perfil
          mainBtn.textContent = "Editar perfil";
          mainBtn.onclick = () => {
            window.location.href = "/settings/profile";
          };
        } else {
          // Es el perfil de otra persona
          // Texto por defecto
          mainBtn.textContent = "Seguir";

          // Consultar estado real en la API
          await actualizarEstadoFollow(mainBtn, user._id);

          mainBtn.onclick = async () => {
            try {
              const yaSigo = mainBtn.textContent === "Siguiendo";
              const method = yaSigo ? "DELETE" : "POST";

              const resp = await fetch(`/api/follow/${user._id}`, {
                method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ myId: loggedUserId }),
              });

              if (!resp.ok) {
                const errJson = await resp.json().catch(() => ({}));
                alert(errJson.message || "No se pudo actualizar el seguimiento");
                return;
              }

              // Alternar texto
              mainBtn.textContent = yaSigo ? "Seguir" : "Siguiendo";

              // Actualizar contador
              const followersSpan = document.getElementById("pFollowers");
              let currentFollowers = Number(followersSpan.textContent) || 0;
              currentFollowers += yaSigo ? -1 : 1;
              followersSpan.textContent = currentFollowers;

            } catch (e) {
              console.error(e);
              alert("Error al intentar seguir a este usuario");
            }
          };
        }



        // ----- Tienda asociada -----
        if (store) {
          const card = document.getElementById("pf-store-card");
          card.style.display = "block";

          document.getElementById("pf-store-name").textContent = store.name;
          document.getElementById("pf-store-address").textContent =
            store.address || "";
          document.getElementById("pf-store-city").textContent =
            [store.district, store.city].filter(Boolean).join(" - ");
          document.getElementById("pf-store-phone").textContent =
            store.phone ? "Tel√©fono: " + store.phone : "";

          const btnCatalog = document.getElementById("pf-store-btn");
          btnCatalog.addEventListener("click", () => {
            window.location.href = `/store/${store._id}`;
          });
        }

        // ----- Posts del usuario -----
        const list = document.getElementById("pf-posts-list");
        list.innerHTML = "";

        if (!posts || posts.length === 0) {
          list.innerHTML =
            '<p class="mg-empty-text">A√∫n no hay publicaciones de este perfil.</p>';
          return;
        }

        posts.forEach(post => {
          const created = new Date(post.createdAt).toLocaleString("es-PE", {
            dateStyle: "short",
            timeStyle: "short",
          });

          const card = document.createElement("article");
          card.className = "mg-post-card";

          card.innerHTML = `
            <header class="mg-post-header">
              <div class="mg-post-avatar">
                ${user.profilePhoto
                  ? `<img src="${user.profilePhoto}" alt="">`
                  : `<div class="mg-avatar-placeholder">
                       ${(user.username || "M")[0].toUpperCase()}
                     </div>`}
              </div>
              <div class="mg-post-meta">
                <div class="mg-post-author">
                  ${user.name || user.username}
                </div>
                <div class="mg-post-date">
                  ${created}
                </div>
              </div>
            </header>

            <div class="mg-post-content">
              <p>${post.content}</p>
            </div>

            <footer class="mg-post-footer">
              <div class="mg-post-actions">
                <button class="mg-action-btn">üëç <span>${post.likesCount || 0}</span></button>
                <button class="mg-action-btn">üí¨ <span>${post.commentsCount || 0}</span></button>
              </div>
            </footer>
          `;

          list.appendChild(card);
        });

      } catch (err) {
        console.error(err);
        alert("Error al cargar el perfil");
      }
    }

    cargarPerfil();
  </script>

  <script>
    // --------- CAMPANITA DE NOTIFICACIONES ----------
    const btnNotif = document.getElementById("btnNotif");
    const notifPanel = document.getElementById("notifPanel");
    const notifList = document.getElementById("notifList");
    let notifLoaded = false;

    async function cargarNotificaciones() {
      notifList.innerHTML = "<p class='mg-notif-empty'>Cargando...</p>";

      try {
        const resp = await fetch(`/api/notifications/${loggedUserId}`);
        const json = await resp.json();

        if (!resp.ok) {
          console.error(json);
          notifList.innerHTML = "<p class='mg-notif-empty'>Error al cargar notificaciones.</p>";
          return;
        }

        const notifs = json.notifications || [];
        if (!notifs.length) {
          notifList.innerHTML = "<p class='mg-notif-empty'>No tienes notificaciones a√∫n.</p>";
          btnNotif.classList.remove("mg-has-unread");
          return;
        }

        notifList.innerHTML = "";
        let hasUnread = false;

        notifs.forEach(n => {
          const item = document.createElement("div");
          item.className = "mg-notif-item" + (n.read ? "" : " mg-notif-unread");
          if (!n.read) hasUnread = true;

          const fromName =
            (n.data && n.data.fromUser && (n.data.fromUser.name || n.data.fromUser.username)) ||
            "Alguien";

          let text;
          if (n.type === "LIKE")      text = `${fromName} le dio like a tu publicaci√≥n.`;
          else if (n.type === "COMMENT") text = `${fromName} coment√≥ tu publicaci√≥n.`;
          else if (n.type === "FOLLOW")  text = `${fromName} empez√≥ a seguirte.`;
          else                          text = "Nueva notificaci√≥n.";

          const fecha = new Date(n.createdAt).toLocaleString("es-PE", {
            dateStyle: "short",
            timeStyle: "short"
          });

          item.innerHTML = `
            <div class="mg-notif-text">${text}</div>
            <div class="mg-notif-date">${fecha}</div>
          `;
          notifList.appendChild(item);
        });

        if (hasUnread) {
          btnNotif.classList.add("mg-has-unread");
        } else {
          btnNotif.classList.remove("mg-has-unread");
        }

      } catch (err) {
        console.error(err);
        notifList.innerHTML = "<p class='mg-notif-empty'>Error de conexi√≥n.</p>";
      }
    }

    btnNotif.addEventListener("click", async () => {
      const visible = notifPanel.style.display === "block";
      if (visible) {
        notifPanel.style.display = "none";
        return;
      }

      notifPanel.style.display = "block";

      if (!notifLoaded) {
        await cargarNotificaciones();
        notifLoaded = true;
      } else {
        await cargarNotificaciones();
      }

      // marcar como le√≠das
      fetch(`/api/notifications/${loggedUserId}/read`, {
        method: "POST"
      }).catch(() => {});
    });
  </script>

  <script>
    // --------- BUSCADOR ----------
    const searchInput = document.querySelector(".mg-search");
    const searchResults = document.getElementById("searchResults");

    let timeoutSearch = null;

    searchInput.addEventListener("input", () => {
      clearTimeout(timeoutSearch);
      const q = searchInput.value.trim();

      if (q.length < 2) {
        searchResults.classList.add("hidden");
        return;
      }

      timeoutSearch = setTimeout(() => {
        buscar(q);
      }, 200);
    });

    async function buscar(q) {
      try {
        const resp = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
        const { stores, users } = await resp.json();

        searchResults.innerHTML = "";

        if (stores.length === 0 && users.length === 0) {
          searchResults.innerHTML =
            "<div class='mg-search-item'>Sin resultados</div>";
          searchResults.classList.remove("hidden");
          return;
        }

        // TIENDAS
        if (stores.length > 0) {
          const label = document.createElement("div");
          label.className = "mg-search-item";
          label.style.fontWeight = "700";
          label.textContent = "Tiendas";
          searchResults.appendChild(label);

          stores.forEach(s => {
            const item = document.createElement("div");
            item.className = "mg-search-item";
            item.textContent = s.name;
            item.onclick = () => {
              window.location.href = `/store/${s._id}`;
            };
            searchResults.appendChild(item);
          });
        }

        // USUARIOS
        if (users.length > 0) {
          const label = document.createElement("div");
          label.className = "mg-search-item";
          label.style.fontWeight = "700";
          label.textContent = "Personas";
          searchResults.appendChild(label);

          users.forEach(u => {
            const item = document.createElement("div");
            item.className = "mg-search-item";
            item.textContent = u.name;
            item.onclick = () => {
              window.location.href = `/profile/${u._id}`;
            };
            searchResults.appendChild(item);
          });
        }

        searchResults.classList.remove("hidden");

      } catch (err) {
        console.error("Error buscando:", err);
      }
    }

    document.addEventListener("click", (e) => {
      if (!searchInput.contains(e.target)) {
        searchResults.classList.add("hidden");
      }
    });
  </script>

</body>
</html>
